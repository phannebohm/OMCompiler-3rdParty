# omc-egg interface

This library creates an interface between `omc` and `egg`.


## Why this interface exists

[`omc`](https://github.com/OpenModelica/OpenModelica) is a compiler for the
[Modelica](https://modelica.org/) language developed by the
[OSMC](https://openmodelica.org/).
Modelica models contain mathematical equations.
These equations are manipulated and new equations and expressions are
generated by `omc`.
`omc` absolutely needs to simplify these equations and expressions to get
correct information about causal dependency and sparsity of equation systems
(and perhaps other things).

[`egg`](https://github.com/egraphs-good/egg) uses e-graphs to efficiently
represent a congruence relation over expressions and apply rewrite rules on them
to discover new congruences.
This can be used to simplify mathematical expressions.
Also see their [paper](https://dl.acm.org/doi/pdf/10.1145/3434304).

The old backend of `omc` used a greedy aproach for simplifying.
This approach is approximately equivalent to a random walk on the e-nodes inside
the e-class representing the expression, where two e-nodes would be connected
iff there is a rewrite rule leading from one to the other.

The hope is that `egg` is able to simplify expressions

1. faster and/or

2. more thoroughly.


## Dependencies

Follow the instructions
[here](https://github.com/OpenModelica/OpenModelica?tab=readme-ov-file#working-with-the-repository)
to get `omc`.

Install Rust. One way to do this is with
[`rustup`](https://www.rust-lang.org/tools/install).

Checkout [my branch](https://github.com/phannebohm/OpenModelica/tree/rust) and
compile it (don't forget to update all submodules).

If it doesn't compile then either you did something wrong or I forgot to mention
some setup steps.

## Development

`egg` is written in [Rust](https://www.rust-lang.org/).
It is used as a 3rdParty library.
No changes are made to egg directly.
Instead all rust functions are defined inside
`OMCompiler/3rdParty/egg_interface/src/lib.rs`.
The interfacing functions obey the C ffi so that MetaModelica thinks they are
C functions and can be called like normal `external "C"` functions with
`annotation(Library="omcruntime");`.

These functions are called in `OMCompiler/Compiler/Util/EGraph.mo` where the
MetaModelica side of the interface lives.
This code is only supposed to translate between MetaModelica and Rust as well
as do some bookkeeping.

### Rust Analyzer

Specify the location of egg_interface:

```json
  "rust-analyzer.linkedProjects": [
    "${workspaceFolder}/OMCompiler/3rdParty/egg_interface/Cargo.toml"
  ]
```

### Testing

Run unit and integration tests:

```bash
cargo test
```

## Documentation

Run `cargo doc --open` to build and open the documentation in a browser.
